# 💰 コスト制御ガイド

## Amazon Bedrock (Claude 3.5 Haiku) 料金

### 基本料金
- **入力トークン**: $0.80 / 1M tokens
- **出力トークン**: $4.00 / 1M tokens

### 1投稿あたりのコスト

| 項目 | トークン数 | コスト |
|------|-----------|--------|
| 入力（プロンプト + 過去投稿） | 約300 | $0.00024 |
| 出力（なんJ風短文） | 約50 | $0.0002 |
| **合計** | **350** | **約$0.00044 (0.066円)** |

## 使用量シミュレーション

### 開発環境（テスト）
```
1日あたり:
- 手動テスト: 50投稿
- 自動スレッド: 0（RSS無効）
= 50投稿/日 × $0.00044 = $0.022/日 (約3.3円/日)
月間: 約$0.66 (約99円/月)
```

### 本番環境（軽量運用）
```
1日あたり:
- RSSスレッド: 10スレッド × 4投稿 = 40投稿
- ユーザー生成: 100投稿
= 140投稿/日 × $0.00044 = $0.062/日 (約9.3円/日)
月間: 約$1.86 (約279円/月)
```

### 本番環境（活発運用）
```
1日あたり:
- RSSスレッド: 48スレッド × 5投稿 = 240投稿
- ユーザー生成: 500投稿
= 740投稿/日 × $0.00044 = $0.326/日 (約49円/日)
月間: 約$9.78 (約1,467円/月)
```

## 実装されたコスト制御機能

### 1. 日次制限
```env
DAILY_MAX_REQUESTS=500  # デフォルト: 500リクエスト/日
```
- 毎日0時（UTC）にリセット
- 超過時: ランダムななんJ語録を返す（Bedrock呼び出しなし）
- 推定コスト: 最大 $0.22/日 (約33円/日)

### 2. 月次制限
```env
MONTHLY_MAX_REQUESTS=10000  # デフォルト: 10,000リクエスト/月
```
- 毎月1日にリセット
- 超過時: ランダムななんJ語録を返す
- 推定コスト: 最大 $4.40/月 (約660円/月)

### 3. レート制限
```env
MAX_REQUESTS_PER_MINUTE=10  # デフォルト: 10リクエスト/分
```
- 1分間のリクエスト数を制限
- 超過時: エラーメッセージを返す
- 目的: 意図しない連続呼び出しを防止

## 使用状況の確認

### Web UI
```
http://localhost:3000/stats
```
リアルタイムで以下を確認:
- 本日の使用量 & コスト
- 今月の使用量 & コスト
- 制限までの残り

### API
```bash
curl http://localhost:3001/api/stats/usage
```

## 推奨設定

### 開発環境
```env
DAILY_MAX_REQUESTS=100
MONTHLY_MAX_REQUESTS=1000
MAX_REQUESTS_PER_MINUTE=5
```
推定コスト: 最大 $0.44/月

### 本番環境（小規模）
```env
DAILY_MAX_REQUESTS=500
MONTHLY_MAX_REQUESTS=10000
MAX_REQUESTS_PER_MINUTE=10
```
推定コスト: 最大 $4.40/月

### 本番環境（中規模）
```env
DAILY_MAX_REQUESTS=2000
MONTHLY_MAX_REQUESTS=50000
MAX_REQUESTS_PER_MINUTE=20
```
推定コスト: 最大 $22.00/月

## 緊急時の対応

### 即座に停止
```bash
# バックエンドを停止
pm2 stop thread-backend
```

### 制限を厳しくする
```env
# backend/.env
DAILY_MAX_REQUESTS=0  # すべてのBedrockリクエストをブロック
```

### RSSの自動スレッド作成を無効化
```env
# backend/.env
RSS_FEEDS=  # 空にする
```

## AWS Budgets設定（推奨）

AWSコンソールで予算アラートを設定:

1. AWS Budgets にアクセス
2. 「予算を作成」
3. 予算タイプ: コスト予算
4. 金額: $5.00/月
5. アラート: 80%で通知

## モニタリング

### CloudWatch Logs
Bedrockの呼び出しログを確認:
```bash
aws logs tail /aws/bedrock/modelinvocations --follow
```

### ローカルログ
```bash
# バックエンドログ確認
pm2 logs thread-backend
```

## よくある質問

**Q: 制限に達したらどうなる？**
A: Bedrockを呼ばず、ランダムななんJ語録が返されます。エラーにはなりません。

**Q: 制限をリセットできる？**
A: データベースを直接編集すれば可能ですが、推奨しません。

**Q: 無料枠はある？**
A: Bedrockには無料枠がありません。すべて従量課金です。

**Q: 最も安全な設定は？**
A: `DAILY_MAX_REQUESTS=50` で1日最大$0.022（約3.3円）に抑えられます。
