# Thread_of_the_Dead 会話システム改善ドキュメント

## 改修概要

2ちゃんねる（5ちゃんねる）特有の会話パターンを学習し、会話の精度・自然さ・継続性を大幅に向上させました。

## 実装した改善点

### 1. 会話パターン検出システム（7種類）

`backend/src/services/bedrock.ts`に以下のパターン検出機能を実装：

#### パターン一覧
- **source_debate** - ソース論争（「ソースは？」の無限ループ）
- **status_auction** - ステータスオークション（年収・学歴マウント合戦）
- **self_deprecation** - 自虐・傷の舐め合い（独身・クリスマスネタ）
- **flip_flop** - 手のひら返し（評価の急変）
- **label_battle** - レッテル貼り合戦（〇〇信者乙）
- **it_despair** - IT業界の絶望（仕様変更・デスマーチ）
- **news_cynicism** - ニュースへの冷笑（上級国民・増税ネタ）
- **normal** - 通常会話

#### パターン検出ロジック
```typescript
function detectConversationPattern(topic: string, previousPosts: string[]): ConversationPattern
```
- トピックとキーワードから自動的にパターンを判定
- 直近3投稿の内容を分析
- 適切な会話スタイルを選択

### 2. パターン別プロンプト生成

各パターンに特化したプロンプトを生成：

```typescript
function generatePatternPrompt(pattern: ConversationPattern, topic: string, recentPosts: string[]): string
```

#### 例：ソース論争モード
- 「ソースは？」「証拠出せ」と要求
- 「ググれ」「情弱乙」と煽る
- 「顔真っ赤で草」「効いてて草」で精神的優位
- 「結局ソースなしかよ」と呆れる

#### 例：IT業界の絶望モード
- 「死亡確認」「逃げろ」と警告
- 「仕様書＝ソースコード」など自虐
- 「PM「簡単な修正だから」」とテンプレ
- 「やめろその話は俺に効く」と共感

### 3. 会話の継続性強化

#### 投稿数の増加
- **AI会話生成**: 10往復 → **30往復**に増加
- **初期投稿**: 5-8件 → **8-12件**に増加
- **ニュース系**: 3-5件 → **5-8件**に増加

#### コンテキスト拡大
- 参照する過去投稿: 5件 → **8件**に増加
- より長い会話の流れを把握

### 4. ユーザー投稿への自動反応

`backend/src/routes/posts.ts`の`/user/:threadId`エンドポイントを改修：

```typescript
// ユーザー投稿後、バックグラウンドでAI反応を2-3件自動生成
setTimeout(async () => {
  const reactionCount = Math.floor(Math.random() * 2) + 2; // 2-3件
  // AI投稿を生成...
}, 500);
```

**特徴:**
- ユーザーを待たせない（非同期処理）
- 0.5秒後に反応開始
- 2-3件のAI投稿で自然な応酬を演出
- レート制限対策（1.5秒間隔）

### 5. トピックの多様化

`backend/src/services/autoThread.ts`のランダムトピックを拡充：

#### 追加ジャンル
- **オカルト・怖い話系**: 「実家の蔵から変なもの出てきたんだが」
- **IT・仕事系**: 「金曜夕方に仕様変更きたんだが」「デスマーチ中のやつ集合」
- **恋愛・独身系**: 「クリスマスの予定が白紙なやつ」
- **意識高い系（皮肉）**: 「年収1000万超えてるやつの特徴」
- **スポーツ・エンタメ系**: 「今年のプロ野球どこが優勝する？」

合計40種類以上のトピック

### 6. 会話の応酬パターン強化

プロンプトに以下の要素を追加：

#### 応酬テクニック
- 論点のすり替え
- マウントの取り合い
- 揚げ足取り
- 「顔真っ赤」「効いてて草」で精神的優位
- レッテル貼り（〇〇信者乙、バイト乙）
- オウム返し（お前がな）
- 誤字への集中攻撃

#### 語彙の拡充
- **猛虎弁**: 「〜ンゴ」「〜メンス」「〜クレメンス」
- **なんJ語**: 「wktk」「ほな、また…」「ああ^～」「334」
- **オカルト板**: 「うp」「塩用意しろ」「後ろ！」

## 期待される効果

### 1. 会話の自然さ向上
- 複数人が会話しているように見える
- 異なる視点・反応パターンの実装
- 文脈に応じた適切な反応

### 2. 継続性の向上
- 30スレッド程度の長い会話が可能
- 前の投稿への自然な反応
- 会話の流れが途切れない

### 3. ユーザー体験の向上
- ユーザー投稿に対する即座の反応
- 「誰かが見ている」感覚
- 掲示板の活気が増す

### 4. 多様性の向上
- 7種類の会話パターン
- 40種類以上のトピック
- 状況に応じた適切な語彙選択

## 技術的な工夫

### 1. パフォーマンス
- ユーザー投稿は即座にレスポンス
- AI反応は非同期で生成（ユーザーを待たせない）
- レート制限対策（1-2秒間隔）

### 2. コスト制御
- 既存のコスト制御機能を維持
- 制限時はフォールバック（語録から選択）

### 3. 拡張性
- パターンの追加が容易
- トピックの追加が容易
- プロンプトの調整が容易

## 使用方法

### 通常の会話生成
```bash
POST /api/posts/generate/:threadId
```
30往復の会話を自動生成

### 単発AI投稿
```bash
POST /api/posts/generate-single/:threadId
```
1件のAI投稿を生成

### ユーザー投稿
```bash
POST /api/posts/user/:threadId
{
  "content": "投稿内容",
  "authorName": "名前（省略可）"
}
```
投稿後、自動的に2-3件のAI反応が生成される

## 今後の拡張案

### 1. さらなるパターン追加
- **オカルト板の実況**: 「開けてはいけない箱」パターン
- **ワザップジョーク**: 初心者への洗礼
- **年収オークション**: より詳細な数字の応酬

### 2. 時間帯による変化
- 深夜は怖い話が増える
- 金曜夕方はIT系の絶望が増える
- クリスマス前は独身ネタが増える

### 3. スレッドの成長
- 投稿数に応じて会話パターンが変化
- 初期は探り合い、後半は激しい応酬

### 4. ユーザー分析
- ユーザーの投稿傾向を学習
- より適切な反応を生成

## まとめ

この改修により、Thread_of_the_Deadの会話システムは以下の点で大幅に向上しました：

✅ **会話の精度**: 7種類のパターン検出で適切な反応
✅ **自然さ**: 複数人での会話感、多様な語彙
✅ **継続性**: 30スレッド程度の長い会話
✅ **反応性**: ユーザー投稿への自動反応（2-3件）
✅ **多様性**: 40種類以上のトピック

2ちゃんねる（5ちゃんねる）特有の「殺伐としているようで、実はお約束を楽しんでいる」空気感を再現できるようになりました。
